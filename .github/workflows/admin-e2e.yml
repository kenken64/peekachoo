name: Admin E2E Tests

on:
  push:
    branches: [main]
    paths:
      - 'peekachoo-admin/src/**'
      - 'peekachoo-admin/e2e/**'
      - 'peekachoo-admin/playwright.config.ts'
      - '.github/workflows/admin-e2e.yml'
  pull_request:
    branches: [main]
    paths:
      - 'peekachoo-admin/src/**'
      - 'peekachoo-admin/e2e/**'
      - 'peekachoo-admin/playwright.config.ts'
      - '.github/workflows/admin-e2e.yml'
  workflow_dispatch:
  schedule:
    # Run daily at 6 AM UTC to catch any regressions
    - cron: '0 6 * * *'

permissions:
  contents: read

env:
  ADMIN_URL: https://peekachoo-admin-production.up.railway.app/
  ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}

jobs:
  e2e-tests:
    name: Playwright E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: peekachoo-admin/package-lock.json

      - name: Install dependencies
        working-directory: peekachoo-admin
        run: npm ci

      - name: Install Playwright browsers
        working-directory: peekachoo-admin
        run: npx playwright install --with-deps chromium

      - name: Run Playwright tests
        working-directory: peekachoo-admin
        run: npx playwright test
        env:
          ADMIN_URL: ${{ env.ADMIN_URL }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: peekachoo-admin/playwright-report/
          retention-days: 7
          if-no-files-found: warn

      - name: Upload test screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-screenshots
          path: peekachoo-admin/test-results/
          retention-days: 7
          if-no-files-found: ignore

      - name: Generate Test Summary
        if: always()
        working-directory: peekachoo-admin
        run: |
          echo "## ðŸŽ­ Admin E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target URL:** $ADMIN_URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f playwright-report/index.html ]; then
            echo "âœ… Playwright report generated successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Download the **playwright-report** artifact to view detailed results." >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Playwright report not found" >> $GITHUB_STEP_SUMMARY
          fi

  smoke-test:
    name: Quick Smoke Test
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Health check
        run: |
          echo "Checking if admin panel is accessible..."
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://peekachoo-admin-production.up.railway.app/")
          
          if [ "$STATUS" = "200" ]; then
            echo "âœ… Admin panel is accessible (HTTP $STATUS)"
          else
            echo "âŒ Admin panel returned HTTP $STATUS"
            exit 1
          fi

      - name: Generate Summary
        run: |
          echo "## ðŸ”¥ Smoke Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Admin Panel Accessible | âœ… Pass |" >> $GITHUB_STEP_SUMMARY
