#!/bin/sh
#
# Pre-push hook for Peekachoo
# Runs Biome lint on all three modules before allowing push
# All modules must pass with 0 errors

echo "=========================================="
echo "Running pre-push lint checks..."
echo "=========================================="

# Get the root directory of the repository
ROOT_DIR="$(git rev-parse --show-toplevel)"

# Track if any lint fails
FAILED=0

# Colors for output (works in Git Bash on Windows)
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to run lint on a module
run_lint() {
    MODULE_NAME=$1
    MODULE_PATH="$ROOT_DIR/$2"

    if [ -d "$MODULE_PATH" ]; then
        echo ""
        echo "${YELLOW}Linting $MODULE_NAME...${NC}"
        cd "$MODULE_PATH"

        if npm run lint; then
            echo "${GREEN}✓ $MODULE_NAME passed lint${NC}"
        else
            echo "${RED}✗ $MODULE_NAME failed lint${NC}"
            FAILED=1
        fi
    else
        echo "${YELLOW}⚠ $MODULE_NAME not found at $MODULE_PATH, skipping...${NC}"
    fi
}

# Run lint on all three modules
run_lint "Frontend" "peekachoo-frontend"
run_lint "Backend" "peekachoo-backend"
run_lint "Admin" "peekachoo-admin"

echo ""
echo "=========================================="

# Check if any lint failed
if [ $FAILED -eq 1 ]; then
    echo "${RED}✗ PUSH BLOCKED: One or more modules failed lint${NC}"
    echo ""
    echo "To fix:"
    echo "  1. Run 'npm run lint:fix' in the failing module(s)"
    echo "  2. Manually fix any remaining issues"
    echo "  3. Commit the fixes"
    echo "  4. Try pushing again"
    echo ""
    echo "To bypass this hook (not recommended):"
    echo "  git push --no-verify"
    echo "=========================================="
    exit 1
fi

echo "${GREEN}✓ All modules passed lint - push allowed${NC}"
echo "=========================================="
exit 0
